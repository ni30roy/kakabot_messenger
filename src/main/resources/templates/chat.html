<!DOCTYPE html>
<html lang="en">
<head>

    <style>
        #chat-section .card {
            background: #121212;
            color: white;
            border: 1px solid #333;
        }

        #chat-section .card-header {
            background: #1f1f1f !important;
            color: #fff;
        }

        #messages {
            background: #1a1a1a !important;
            color: #fff;
        }

        #chat-section .card-footer {
            background: #1f1f1f;
        }

        #msg {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
        }

        #msg::placeholder {
            color: #ccc;
        }
    </style>

    <meta charset="UTF-8">
    <title>KakaBot Messenger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand">ðŸ¤– KakaBot Messenger</span>
    <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container mt-4">

    <!-- STATUS -->
    <div id="info" class="alert alert-info"></div>

    <!-- ADMIN: FRIEND REQUESTS -->
    <div id="admin-requests" class="mb-3"></div>

    <!-- USER: SEND FRIEND REQUEST -->
    <div id="send-request-box" style="display:none;">
        <button class="btn btn-warning mb-3"
                onclick="sendFriendRequest()">
            Send Friend Request to ramukaka-munna
        </button>
    </div>

    <!-- CHAT SECTION -->
    <div id="chat-section" style="display:none;">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                Chat with <span id="chat-with"></span>
            </div>

            <div id="messages"
                 class="card-body"
                 style="height:300px; overflow-y:auto; background:#1e1e1e; color:white;">
            </div>


            <div class="card-footer d-flex">
                <input id="msg" class="form-control"
                       placeholder="Type message..."
                       onkeydown="if(event.key==='Enter') sendMessage()">
                <button class="btn btn-primary ms-2"
                        onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* =====================
       AUTH
    ===================== */
    const token = localStorage.getItem("token");
    if (!token) location.href = "/login";

    const ADMIN = "ramukaka-munna";
    let currentChatUser = null;

    function headers() {
        return { "Authorization": "Bearer " + token };
    }

    function logout() {
        localStorage.removeItem("token");
        location.href = "/login";
    }

    /* =====================
       FRIEND STATUS
    ===================== */
    fetch("/api/friend/status", { headers: headers() })
        .then(r => r.text())
        .then(status => {

            const info = document.getElementById("info");

            if (status === "NONE") {
                info.innerText = "You are not connected with ramukaka-munna.";
                document.getElementById("send-request-box").style.display = "block";
            }
            else if (status === "PENDING") {
                info.innerText = "Waiting ramukaka-munna to accept your request.";
            }
            else if (status === "ACCEPTED") {
                info.innerText = "Connected with ramukaka-munna. You can chat now.";
                openChat("ramukaka-munna"); // âœ… USER CHAT OPEN
            }
            else if (status === "ADMIN") {
                info.innerText = "Admin Dashboard (ramukaka-munna)";
                loadPendingRequests();
                autoOpenLastChat(); // âœ… ADMIN CHAT OPEN
            }
        });

    /* =====================
       FRIEND REQUEST
    ===================== */
    function sendFriendRequest() {
        fetch("/api/friend/request", {
            method: "POST",
            headers: headers()
        }).then(() => location.reload());
    }

    function loadPendingRequests() {
        fetch("/api/friend/pending", { headers: headers() })
            .then(r => r.json())
            .then(data => {

                const box = document.getElementById("admin-requests");

                if (!data || data.length === 0) {
                    box.innerHTML = "<div class='alert alert-secondary'>No pending requests</div>";
                    return;
                }

                let html = `
                  <div class="card">
                    <div class="card-header bg-warning">
                        Pending Friend Requests
                    </div>
                    <div class="card-body">
                `;

                data.forEach(r => {
                    html += `
                      <div class="d-flex justify-content-between mb-2">
                        <b>${r.sender}</b>
                        <button class="btn btn-sm btn-success"
                                onclick="accept(${r.id})">
                            Accept
                        </button>
                      </div>
                    `;
                });

                html += "</div></div>";
                box.innerHTML = html;
            });
    }

    function accept(id) {
        fetch("/api/friend/accept/" + id, {
            method: "POST",
            headers: headers()
        }).then(() => location.reload());
    }

    /* =====================
       ADMIN AUTO OPEN CHAT
    ===================== */
    function autoOpenLastChat() {
        fetch("/api/message/all", { headers: headers() })
            .then(r => r.json())
            .then(data => {
                if (!data || data.length === 0) return;

                const last = data[data.length - 1];
                const otherUser =
                    last.sender === ADMIN ? last.receiver : last.sender;

                openChat(otherUser);
            });
    }

    /* =====================
       CHAT FUNCTIONS
    ===================== */
    function openChat(user) {
        if (!user) return;

        currentChatUser = user;
        document.getElementById("chat-with").innerText = user;
        document.getElementById("chat-section").style.display = "block";

        loadMessages();
    }

    function sendMessage() {
        const input = document.getElementById("msg");
        const text = input.value.trim();

        if (!text || !currentChatUser) return;

        fetch("/api/message/send", {
            method: "POST",
            headers: {
                ...headers(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                receiver: currentChatUser,
                content: text
            })
        }).then(() => {
            input.value = "";
            loadMessages();
        });
    }

    function loadMessages() {
        if (!currentChatUser) return;

        fetch("/api/message/chat/" + currentChatUser, {
            headers: headers()
        })
        .then(r => r.json())
        .then(data => {
            const box = document.getElementById("messages");
            box.innerHTML = "";

            if (!data || data.length === 0) {
                box.innerHTML = "<div class='text-muted'>No messages yet</div>";
                return;
            }

            data.forEach(m => {
                box.innerHTML += `
                  <div class="mb-1">
                    <b>${m.sender}:</b> ${m.content}
                  </div>
                `;
            });

            box.scrollTop = box.scrollHeight;
        });
    }

    // Auto refresh every 3 sec
    setInterval(() => {
        if (currentChatUser) loadMessages();
    }, 3000);

</script>

</body>
</html>