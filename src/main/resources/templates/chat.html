<!DOCTYPE html>
<html>
<head>
    <title>KakaBot Messenger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; background:#eef2f5; margin:0 }
        header { background:#1f2937; color:white; padding:10px; display:flex; justify-content:space-between }
        .container { display:flex; gap:20px; padding:15px }
        .panel { background:white; padding:12px; border-radius:8px; width:260px }
        #chatPanel { flex:1; background:white; padding:12px; border-radius:8px }
        #chatBox { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px }
        .msg { margin-bottom:6px }
        .me { text-align:right; color:blue }
        .other { text-align:left }
        button { padding:6px 10px; cursor:pointer }
        .hidden { display:none }
        .item { cursor:pointer; margin-bottom:6px }
    </style>
</head>

<body>

<header>
    <b>KakaBot Messenger</b>
    <button onclick="logout()">Logout</button>
</header>

<div class="container">

    <!-- USER PANEL -->
    <div id="userPanel" class="panel hidden">
        <h3>Friend Request</h3>
        <div id="friendStatus">Loading...</div><br>
        <button id="sendReqBtn" onclick="sendRequest()">Send Friend Request</button>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="panel hidden">
        <h3>Pending Requests</h3>
        <div id="pendingList"></div>
        <hr>
        <h3>Users</h3>
        <div id="userList"></div>
    </div>

    <!-- CHAT PANEL -->
    <div id="chatPanel" class="hidden">
        <h3 id="chatTitle">Chat</h3>
        <div id="chatBox"></div><br>
        <input id="msg" placeholder="Type message..."
               onkeydown="if(event.key==='Enter') sendMsg()">
        <button onclick="sendMsg()">Send</button>
    </div>

</div>

<script>
    const token = localStorage.getItem("token");
    if (!token) location.href="/login";

    const headers = {
        "Authorization":"Bearer "+token,
        "Content-Type":"application/json"
    };

    const ADMIN = "ramukaka";
    let currentChatUser = null;
    let chatTimer = null;

    function getUser(){
        return JSON.parse(atob(token.split('.')[1])).sub;
    }
    const user = getUser();

    /* INIT */
    window.onload = () => {
        if(user === ADMIN){
            document.getElementById("adminPanel").classList.remove("hidden");
            loadPending();
            loadUsers();
        }else{
            document.getElementById("userPanel").classList.remove("hidden");
            loadStatus();
        }
    };

    /* CHAT OPEN */
    function openChat(u){
        currentChatUser = u;

        document.getElementById("chatPanel").classList.remove("hidden");
        document.getElementById("chatTitle").innerText = "Chat with " + u;

        if(chatTimer) clearInterval(chatTimer);
        loadChat();
        chatTimer = setInterval(loadChat, 2000);
    }

    /* LOAD CHAT */
    async function loadChat(){
        if(!currentChatUser) return;

        const r = await fetch("/api/message/chat?with="+currentChatUser,{headers});
        const data = await r.json();

        const box = document.getElementById("chatBox");
        box.innerHTML="";

        data.forEach(m=>{
            const d=document.createElement("div");
            d.className="msg "+(m.sender===user?"me":"other");
            d.innerText = m.sender+": "+m.content;
            box.appendChild(d);
        });

        box.scrollTop = box.scrollHeight;
    }

    /* SEND */
    async function sendMsg(){
        const i=document.getElementById("msg");
        if(!i.value.trim()) return;

        if(user===ADMIN && !currentChatUser){
            alert("Select a user first");
            return;
        }

        const payload={ content:i.value };
        if(user===ADMIN) payload.receiver=currentChatUser;

        await fetch("/api/message/send",{
            method:"POST",
            headers,
            body:JSON.stringify(payload)
        });

        i.value="";
        loadChat();
    }

    /* LOGOUT */
    function logout(){
        localStorage.removeItem("token");
        location.href="/login";
    }
</script>

</body>
</html>